import dotenv from "dotenv";

dotenv.config();

// Permission constants
const PERMISSIONS = {
  notifications: "We use notifications to keep you updated about important alerts.",
};

function getBundleIdentifier() {
  const appVariant = process.env.EXPO_PUBLIC_APP_VARIANT;
  const baseBundleId = "{{bundleId}}";
  if (appVariant === "prod") return baseBundleId;
  if (appVariant === "preprod") return `${baseBundleId}.preprod`;
  if (appVariant === "qa") return `${baseBundleId}.qa`;
  return `${baseBundleId}.develop`;
}

function getAndroidPackage() {
  const bundleId = getBundleIdentifier();
  
  // Android package name validation and sanitization
  // Rules: Only alphanumeric, '.', '_' allowed. Each '.' must be followed by a letter.
  // Reserved Java keywords are not allowed.
  
  // Reserved Java keywords that cannot be used
  const reservedKeywords = new Set([
    'abstract', 'assert', 'boolean', 'break', 'byte', 'case', 'catch', 'char',
    'class', 'const', 'continue', 'default', 'do', 'double', 'else', 'enum',
    'extends', 'final', 'finally', 'float', 'for', 'goto', 'if', 'implements',
    'import', 'instanceof', 'int', 'interface', 'long', 'native', 'new', 'package',
    'private', 'protected', 'public', 'return', 'short', 'static', 'strictfp',
    'super', 'switch', 'synchronized', 'this', 'throw', 'throws', 'transient',
    'try', 'void', 'volatile', 'while'
  ]);
  
  // Split by dots and validate each segment
  const segments = bundleId.split('.');
  const sanitizedSegments = segments.map((segment, index) => {
    if (!segment) {
      throw new Error(`Invalid Android package name: empty segment at position ${index} in "${bundleId}"`);
    }
    
    // Replace invalid characters with underscores
    let sanitized = segment.replace(/[^a-zA-Z0-9_]/g, '_');
    
    // Ensure segment starts with a letter (required for Android package names)
    // Each segment after a dot must start with a letter
    if (!/^[a-zA-Z]/.test(sanitized)) {
      sanitized = 'a' + sanitized;
    }
    
    // Check for reserved Java keywords and append underscore if found
    if (reservedKeywords.has(sanitized.toLowerCase())) {
      sanitized = sanitized + '_';
    }
    
    return sanitized;
  });
  
  const sanitized = sanitizedSegments.join('.');
  
  // Final validation: ensure it matches Android package name pattern
  if (!/^[a-zA-Z_][a-zA-Z0-9_]*(\.[a-zA-Z_][a-zA-Z0-9_]*)*$/.test(sanitized)) {
    throw new Error(`Invalid Android package name format: "${sanitized}" (derived from "${bundleId}")`);
  }
  
  return sanitized;
}

function getIconPath(prefix: string) {
  const appVariant = process.env.EXPO_PUBLIC_APP_VARIANT;
  if (appVariant === "prod") return `./src/assets/icons/${prefix}-prod.png`;
  if (appVariant === "preprod") return `./src/assets/icons/${prefix}-preprod.png`;
  if (appVariant === "qa") return `./src/assets/icons/${prefix}-qa.png`;
  return `./src/assets/icons/${prefix}-develop.png`;
}

function getSplashPath() {
  // Use the same icon image for splash screen
  return getAppIcon();
}

function getAppIcon() {
  return getIconPath("icon");
}

function getAdaptiveIcon() {
  return getIconPath("adaptive-icon");
}

export default {
  name: "{{projectName}}",
  slug: "{{projectSlug}}",
  version: "1.0.0",
  orientation: "portrait",
  icon: getAppIcon(),
  splash: {
    image: getSplashPath(),
    resizeMode: "cover",
    backgroundColor: "#000000",
  },
  scheme: getBundleIdentifier(),
  userInterfaceStyle: "automatic",
  experiments: {
    reactCompiler: true,
  },
  ios: {
    supportsTablet: false,
    bundleIdentifier: getBundleIdentifier(),
    icon: getAppIcon(),
    infoPlist: {
      NSUserNotificationUsageDescription: PERMISSIONS.notifications,
    },
  },
  android: {
    package: getAndroidPackage(),
    edgeToEdgeEnabled: true,
    icon: getAppIcon(),
    adaptiveIcon: {
      foregroundImage: getAdaptiveIcon(),
      backgroundColor: "#ffffff",
    },
  },
  plugins: [
    "expo-font",
    [
      "expo-notifications",
      {
        icon: getAppIcon(),
        color: "#ffffff",
        defaultChannel: "default",
        enableBackgroundRemoteNotifications: false,
      },
    ],
  ],
};

